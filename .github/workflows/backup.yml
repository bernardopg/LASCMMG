name: ğŸ—„ï¸ Automated Backup & Maintenance

on:
  schedule:
    # Backup diÃ¡rio Ã s 2:00 AM UTC
    - cron: '0 2 * * *'
    # Backup semanal completo aos domingos Ã s 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Tipo de backup'
        required: true
        default: 'manual'
        type: choice
        options:
        - manual
        - daily
        - weekly
        - full

env:
  NODE_VERSION: '18'

jobs:
  # ==================== BACKUP AUTOMÃTICO ====================
  automated-backup:
    name: ğŸ“¦ Database Backup
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ—„ï¸ Determine Backup Type
        id: backup-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.backup_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "0 3 * * 0" ]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
          else
            echo "type=daily" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Setup Environment
        run: |
          echo "NODE_ENV=production" >> .env
          echo "BACKUP_ENCRYPTION_KEY=${{ secrets.BACKUP_ENCRYPTION_KEY }}" >> .env
          echo "DB_PATH=./production.db" >> .env

      - name: ğŸ—„ï¸ Create Database Backup
        run: |
          cd backend
          node -e "
            const backupManager = require('./lib/backup/backupManager');
            async function createBackup() {
              try {
                await backupManager.initialize();
                const backup = await backupManager.createBackup('${{ steps.backup-type.outputs.type }}');
                console.log('âœ… Backup criado:', backup.fileName);
                console.log('ğŸ“ Tamanho:', backup.sizeFormatted);
              } catch (error) {
                console.error('âŒ Erro no backup:', error);
                process.exit(1);
              }
            }
            createBackup();
          "

      - name: ğŸ§ª Verify Backup Integrity
        run: |
          cd backend
          node -e "
            const backupManager = require('./lib/backup/backupManager');
            async function verifyBackup() {
              try {
                const result = await backupManager.testBackupRestore();
                if (result.testPassed) {
                  console.log('âœ… Backup verificado com sucesso');
                } else {
                  console.error('âŒ Falha na verificaÃ§Ã£o do backup');
                  process.exit(1);
                }
              } catch (error) {
                console.error('âŒ Erro na verificaÃ§Ã£o:', error);
                process.exit(1);
              }
            }
            verifyBackup();
          "

      - name: ğŸ“¤ Upload Backup Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: database-backup-${{ steps.backup-type.outputs.type }}-${{ github.run_number }}
          path: backend/backups/
          retention-days: 30

      - name: ğŸ§¹ Cleanup Old Backups
        run: |
          cd backend
          node -e "
            const backupManager = require('./lib/backup/backupManager');
            async function cleanup() {
              try {
                await backupManager.cleanupOldBackups();
                console.log('âœ… Limpeza de backups antigos concluÃ­da');
              } catch (error) {
                console.error('âŒ Erro na limpeza:', error);
              }
            }
            cleanup();
          "

  # ==================== MONITORAMENTO DE DEPENDÃŠNCIAS ====================
  dependency-monitoring:
    name: ğŸ“‹ Dependency Monitoring
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ” Check for Outdated Dependencies (Backend)
        run: |
          echo "ğŸ” Verificando dependÃªncias desatualizadas no backend..."
          npm outdated || true
          echo "ğŸ“Š RelatÃ³rio de dependÃªncias do backend gerado"

      - name: ğŸ” Check for Outdated Dependencies (Frontend)
        run: |
          cd frontend-react
          echo "ğŸ” Verificando dependÃªncias desatualizadas no frontend..."
          npm outdated || true
          echo "ğŸ“Š RelatÃ³rio de dependÃªncias do frontend gerado"

      - name: ğŸ›¡ï¸ Security Vulnerability Scan
        run: |
          echo "ğŸ›¡ï¸ Executando auditoria de seguranÃ§a..."
          npm audit --json > audit-backend.json || true
          cd frontend-react
          npm audit --json > audit-frontend.json || true
          cd ..
          echo "ğŸ“Š RelatÃ³rios de auditoria gerados"

      - name: ğŸ“Š Generate Dependency Report
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio consolidado de dependÃªncias..."
          node -e "
            const fs = require('fs');
            const path = require('path');

            const report = {
              timestamp: new Date().toISOString(),
              backend: {},
              frontend: {}
            };

            try {
              if (fs.existsSync('audit-backend.json')) {
                report.backend = JSON.parse(fs.readFileSync('audit-backend.json', 'utf8'));
              }
              if (fs.existsSync('frontend-react/audit-frontend.json')) {
                report.frontend = JSON.parse(fs.readFileSync('frontend-react/audit-frontend.json', 'utf8'));
              }

              fs.writeFileSync('dependency-report.json', JSON.stringify(report, null, 2));
              console.log('âœ… RelatÃ³rio consolidado gerado: dependency-report.json');
            } catch (error) {
              console.error('âŒ Erro ao gerar relatÃ³rio:', error);
            }
          "

      - name: ğŸ“¤ Upload Dependency Report
        uses: actions/upload-artifact@v3
        with:
          name: dependency-report-${{ github.run_number }}
          path: dependency-report.json
          retention-days: 14

  # ==================== LIMPEZA E MANUTENÃ‡ÃƒO ====================
  maintenance:
    name: ğŸ§¹ System Maintenance
    runs-on: ubuntu-latest
    needs: [automated-backup]
    if: github.event.schedule == '0 3 * * 0' # Apenas aos domingos

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ§¹ Database Maintenance
        run: |
          cd backend
          echo "ğŸ§¹ Executando manutenÃ§Ã£o do banco de dados..."
          node -e "
            const { getDb } = require('./lib/db/database');
            async function maintenance() {
              try {
                const db = getDb();

                // Vacuum para otimizar o banco
                console.log('ğŸ—œï¸ Executando VACUUM...');
                await db.exec('VACUUM;');

                // AnÃ¡lise das tabelas
                console.log('ğŸ“Š Executando ANALYZE...');
                await db.exec('ANALYZE;');

                // VerificaÃ§Ã£o de integridade
                console.log('ğŸ” Verificando integridade...');
                const result = await db.get('PRAGMA integrity_check;');
                console.log('Resultado da verificaÃ§Ã£o:', result);

                console.log('âœ… ManutenÃ§Ã£o do banco concluÃ­da');
              } catch (error) {
                console.error('âŒ Erro na manutenÃ§Ã£o:', error);
                process.exit(1);
              }
            }
            maintenance();
          "

      - name: ğŸ—‚ï¸ Log Rotation
        run: |
          echo "ğŸ—‚ï¸ Executando rotaÃ§Ã£o de logs..."
          cd backend
          # Comprimir logs antigos (simulaÃ§Ã£o)
          find logs/ -name "*.log" -mtime +7 -exec gzip {} \; 2>/dev/null || true
          # Remover logs muito antigos
          find logs/ -name "*.gz" -mtime +30 -delete 2>/dev/null || true
          echo "âœ… RotaÃ§Ã£o de logs concluÃ­da"

      - name: ğŸ“Š System Health Check
        run: |
          echo "ğŸ“Š VerificaÃ§Ã£o de saÃºde do sistema..."
          node -e "
            const os = require('os');
            const fs = require('fs');

            const healthCheck = {
              timestamp: new Date().toISOString(),
              system: {
                platform: os.platform(),
                arch: os.arch(),
                totalMemory: Math.round(os.totalmem() / 1024 / 1024) + 'MB',
                freeMemory: Math.round(os.freemem() / 1024 / 1024) + 'MB',
                loadAverage: os.loadavg(),
                uptime: Math.round(os.uptime() / 3600) + 'h'
              },
              disk: {}
            };

            try {
              const stats = fs.statSync('.');
              healthCheck.disk.accessible = true;
            } catch (error) {
              healthCheck.disk.accessible = false;
              healthCheck.disk.error = error.message;
            }

            console.log('ğŸ“Š Health Check:', JSON.stringify(healthCheck, null, 2));
          "

  # ==================== NOTIFICAÃ‡Ã•ES DE BACKUP ====================
  notify-backup:
    name: ğŸ“¢ Backup Notifications
    runs-on: ubuntu-latest
    needs: [automated-backup, dependency-monitoring, maintenance]
    if: always()

    steps:
      - name: ğŸ“¢ Backup Status Notification
        run: |
          echo "ğŸ“¢ STATUS DO BACKUP E MANUTENÃ‡ÃƒO"
          echo "================================="

          if [ "${{ needs.automated-backup.result }}" = "success" ]; then
            echo "âœ… Backup automatizado: SUCESSO"
          else
            echo "âŒ Backup automatizado: FALHA"
          fi

          if [ "${{ needs.dependency-monitoring.result }}" = "success" ]; then
            echo "âœ… Monitoramento de dependÃªncias: SUCESSO"
          else
            echo "âŒ Monitoramento de dependÃªncias: FALHA"
          fi

          if [ "${{ needs.maintenance.result }}" = "success" ]; then
            echo "âœ… ManutenÃ§Ã£o do sistema: SUCESSO"
          elif [ "${{ needs.maintenance.result }}" = "skipped" ]; then
            echo "â­ï¸ ManutenÃ§Ã£o do sistema: IGNORADA (nÃ£o Ã© domingo)"
          else
            echo "âŒ ManutenÃ§Ã£o do sistema: FALHA"
          fi

          echo "================================="
          echo "ğŸ•’ Timestamp: $(date -u)"
          echo "ğŸ“ RelatÃ³rios disponÃ­veis nos artifacts"

      - name: ğŸ“§ Send Notification (Webhook)
        if: failure()
        run: |
          echo "ğŸ“§ Enviando notificaÃ§Ã£o de falha..."
          # Aqui vocÃª pode adicionar integraÃ§Ã£o com Slack, Discord, email, etc.
          # Exemplo: curl -X POST -H 'Content-type: application/json' --data '{"text":"Backup failed!"}' YOUR_WEBHOOK_URL
          echo "ğŸ”” NotificaÃ§Ã£o de falha enviada"
