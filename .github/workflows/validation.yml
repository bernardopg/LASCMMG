name: ğŸ” Workflow Validation

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - 'package.json'
      - 'backend/setup-db.js'

env:
  NODE_VERSION: '18'

jobs:
  validate-basic-setup:
    name: ğŸ“‹ Validate Basic Setup
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Root Dependencies
        run: npm ci

      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend-react
          npm ci

      - name: ğŸ” Validate Package Scripts
        run: |
          echo "Validating package.json scripts..."
          node -e "
            const pkg = require('./package.json');
            const requiredScripts = ['start', 'setup:db', 'health-check', 'test', 'lint'];
            const missing = requiredScripts.filter(script => !pkg.scripts[script]);
            if (missing.length > 0) {
              console.error('Missing scripts:', missing);
              process.exit(1);
            }
            console.log('âœ… All required scripts are present');
          "

      - name: ğŸ”§ Validate Environment Setup
        run: |
          echo "Setting up test environment..."
          cp backend/.env.example backend/.env
          echo "NODE_ENV=test" >> backend/.env
          echo "PORT=3000" >> backend/.env
          echo "JWT_SECRET=test-secret-$(openssl rand -hex 16)" >> backend/.env
          echo "COOKIE_SECRET=test-cookie-$(openssl rand -hex 16)" >> backend/.env
          echo "CSRF_SECRET=test-csrf-$(openssl rand -hex 16)" >> backend/.env
          echo "âœ… Environment configured"

      - name: ğŸ—„ï¸ Test Database Setup
        run: |
          echo "Testing database setup..."
          npm run setup:db
          echo "âœ… Database setup successful"

      - name: ğŸ” Validate Health Check Script
        run: |
          echo "Testing health check script..."
          # Verificar se o script existe e Ã© executÃ¡vel
          if [ ! -f "scripts/health-check.js" ]; then
            echo "âŒ Health check script not found"
            exit 1
          fi

          # Testar sintaxe do script
          node -c scripts/health-check.js
          echo "âœ… Health check script syntax is valid"

      - name: ğŸš€ Test Server Start (Quick)
        run: |
          echo "Testing server startup..."
          # Iniciar servidor em background por um tempo limitado
          timeout 15s npm start &
          SERVER_PID=$!
          sleep 5

          # Verificar se o processo ainda estÃ¡ rodando
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "âœ… Server started successfully"
            kill $SERVER_PID
          else
            echo "âŒ Server failed to start"
            exit 1
          fi

  validate-frontend-build:
    name: ğŸ­ Validate Frontend Build
    runs-on: ubuntu-latest
    needs: [validate-basic-setup]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ—ï¸ Test Frontend Build
        run: |
          echo "Testing frontend build..."
          npm run frontend:build

          # Verificar se os arquivos de build foram criados
          if [ ! -d "frontend-react/dist" ]; then
            echo "âŒ Build directory not created"
            exit 1
          fi

          if [ ! -f "frontend-react/dist/index.html" ]; then
            echo "âŒ index.html not found in build"
            exit 1
          fi

          echo "âœ… Frontend build successful"

      - name: ğŸ“ Check Build Size
        run: |
          echo "Checking build size..."
          du -sh frontend-react/dist/

          # Verificar se o build nÃ£o estÃ¡ muito grande (limite: 50MB)
          SIZE=$(du -sm frontend-react/dist/ | cut -f1)
          if [ $SIZE -gt 50 ]; then
            echo "âš ï¸ Build size is larger than 50MB: ${SIZE}MB"
          else
            echo "âœ… Build size is acceptable: ${SIZE}MB"
          fi

  validate-linting:
    name: ğŸ” Validate Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ” Test Root Linting
        run: |
          echo "Testing root linting..."
          npm run lint -- --max-warnings=10
          echo "âœ… Root linting passed"

      - name: ğŸ” Test Frontend Linting
        run: |
          echo "Testing frontend linting..."
          npm run frontend:lint -- --max-warnings=10
          echo "âœ… Frontend linting passed"

      - name: ğŸ¨ Test Code Formatting
        run: |
          echo "Testing code formatting..."
          npm run format -- --check || {
            echo "âŒ Code formatting issues found. Run 'npm run format' to fix."
            exit 1
          }
          echo "âœ… Code formatting is correct"

  summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-basic-setup, validate-frontend-build, validate-linting]
    if: always()

    steps:
      - name: ğŸ“‹ Print Results
        run: |
          echo "ğŸ¯ Workflow Validation Results:"
          echo "================================"
          echo "Basic Setup: ${{ needs.validate-basic-setup.result }}"
          echo "Frontend Build: ${{ needs.validate-frontend-build.result }}"
          echo "Code Quality: ${{ needs.validate-linting.result }}"
          echo "================================"

          if [ "${{ needs.validate-basic-setup.result }}" = "success" ] && \
             [ "${{ needs.validate-frontend-build.result }}" = "success" ] && \
             [ "${{ needs.validate-linting.result }}" = "success" ]; then
            echo "âœ… All validations passed! Workflows are ready."
          else
            echo "âŒ Some validations failed. Check the logs above."
            exit 1
          fi
