name: ğŸ“Š Performance & Security Monitoring

on:
  schedule:
    # Monitoramento de performance a cada 6 horas
    - cron: '0 */6 * * *'
    # AnÃ¡lise de seguranÃ§a diÃ¡ria Ã s 1:00 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'Tipo de monitoramento'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - performance
          - security
          - lighthouse

env:
  NODE_VERSION: '18'

jobs:
  # ==================== MONITORAMENTO DE PERFORMANCE ====================
  performance-monitoring:
    name: âš¡ Performance Monitoring
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.monitoring_type, 'performance') || contains(github.event.inputs.monitoring_type, 'full') || github.event.schedule == '0 */6 * * *' || github.event_name == 'workflow_dispatch'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ”§ Setup Test Environment
        run: |
          cp backend/.env.example backend/.env
          echo "NODE_ENV=production" >> backend/.env
          echo "PORT=3003" >> backend/.env
          echo "DB_PATH=./monitoring.db" >> backend/.env
          echo "REDIS_URL=redis://localhost:6379" >> backend/.env
          echo "PERFORMANCE_MONITORING_ENABLED=true" >> backend/.env
          echo "QUERY_SLOW_THRESHOLD_MS=100" >> backend/.env

      - name: ğŸ—„ï¸ Initialize Database
        run: |
          cd backend
          node setup-db.js

      - name: ğŸš€ Start Application
        run: |
          cd backend
          node server.js &
          sleep 15
          echo "AplicaÃ§Ã£o iniciada na porta 3003"

      - name: ğŸ“Š Performance Analysis
        run: |
          echo "ğŸ“Š Iniciando anÃ¡lise de performance..."

          # Teste bÃ¡sico de conectividade
          for i in {1..5}; do
            echo "Teste $i/5"
            curl -s -w "Tempo de resposta: %{time_total}s\n" http://localhost:3003/ || true
            sleep 1
          done

          echo "âœ… AnÃ¡lise de performance concluÃ­da"
        continue-on-error: true

      - name: ğŸ” Database Health Check
        run: |
          echo "ğŸ” Verificando saÃºde do banco de dados..."
          cd backend
          node -e "
            const Database = require('better-sqlite3');
            try {
              const db = new Database('./monitoring.db');
              const result = db.prepare('SELECT COUNT(*) as count FROM sqlite_master WHERE type=\"table\"').get();
              console.log('âœ… Banco de dados acessÃ­vel. Tabelas encontradas:', result.count);
              db.close();
            } catch (error) {
              console.error('âŒ Erro no banco de dados:', error.message);
            }
          "
        continue-on-error: true

      - name: ğŸ” Query Performance Analysis
        run: |
          echo "ğŸ” Analisando performance de queries..."
          cd backend
          node -e "
            const Database = require('better-sqlite3');

            async function analyzeQueries() {
              try {
                const db = new Database('./monitoring.db');

                console.log('ğŸ“Š Executando queries de teste...');

                const start = Date.now();
                db.prepare('SELECT COUNT(*) FROM sqlite_master').get();
                const end = Date.now();

                console.log(\`â±ï¸ Query executada em \${end - start}ms\`);

                if (end - start > 100) {
                  console.warn('âš ï¸ Query lenta detectada!');
                } else {
                  console.log('âœ… Nenhuma query lenta detectada');
                }

                console.log('âœ… AnÃ¡lise de queries concluÃ­da');
                db.close();
              } catch (error) {
                console.error('âŒ Erro na anÃ¡lise de queries:', error);
              }
            }

            analyzeQueries();
          " || echo "Query analysis completed with warnings"
        continue-on-error: true

      - name: ğŸ“ˆ Generate Performance Report
        run: |
          echo "ğŸ“ˆ Gerando relatÃ³rio de performance..."
          node -e "
            const fs = require('fs');
            const os = require('os');

            const report = {
              timestamp: new Date().toISOString(),
              system: {
                loadAverage: os.loadavg(),
                freeMemory: Math.round(os.freemem() / 1024 / 1024),
                totalMemory: Math.round(os.totalmem() / 1024 / 1024),
                uptime: os.uptime()
              },
              application: {
                status: 'running',
                port: 3003,
                environment: 'monitoring'
              }
            };

            fs.writeFileSync('performance-report.json', JSON.stringify(report, null, 2));
            console.log('âœ… RelatÃ³rio de performance gerado');
          "

      - name: ğŸ“¤ Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report-${{ github.run_number }}
          path: performance-report.json
          retention-days: 7

  # ==================== LIGHTHOUSE AUDIT ====================
  lighthouse-audit:
    name: ğŸ”¦ Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.monitoring_type, 'lighthouse') || contains(github.event.inputs.monitoring_type, 'full') || github.event.schedule == '0 */6 * * *'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd frontend-react
          npm run build

      - name: ğŸš€ Start Static Server
        run: |
          cd frontend-react
          npx serve -s dist -l 3004 &
          sleep 10
          echo "Servidor estÃ¡tico iniciado na porta 3004"

      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: ğŸ”¦ Run Lighthouse Audit
        run: |
          lhci autorun \
            --upload.target=temporary-public-storage \
            --collect.url=http://localhost:3004 \
            --collect.numberOfRuns=3 \
            --assert.assertions.performance=0.8 \
            --assert.assertions.accessibility=0.9 \
            --assert.assertions.best-practices=0.8 \
            --assert.assertions.seo=0.8 || true

      - name: ğŸ“Š Generate Lighthouse Report Summary
        run: |
          echo "ğŸ“Š Resumo do Lighthouse Audit gerado"
          echo "ğŸ”¦ Audit executado com 3 execuÃ§Ãµes"
          echo "ğŸ“± URL testada: http://localhost:3004"
          echo "âš¡ MÃ©tricas: Performance, Accessibility, Best Practices, SEO"

  # ==================== SECURITY MONITORING ====================
  security-monitoring:
    name: ğŸ”’ Security Monitoring
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.monitoring_type, 'security') || contains(github.event.inputs.monitoring_type, 'full') || github.event.schedule == '0 1 * * *'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ” Security Audit (Backend)
        run: |
          echo "ğŸ” Executando auditoria de seguranÃ§a do backend..."
          npm audit --audit-level=moderate --json > security-audit-backend.json || true
          echo "ğŸ“Š Auditoria do backend concluÃ­da"

      - name: ğŸ” Security Audit (Frontend)
        run: |
          cd frontend-react
          echo "ğŸ” Executando auditoria de seguranÃ§a do frontend..."
          npm audit --audit-level=moderate --json > security-audit-frontend.json || true
          echo "ğŸ“Š Auditoria do frontend concluÃ­da"

      - name: ğŸ›¡ï¸ License Check
        run: |
          echo "ğŸ›¡ï¸ Verificando licenÃ§as..."
          npx license-checker --summary > license-summary.txt || true
          cd frontend-react
          npx license-checker --summary > license-summary-frontend.txt || true
          echo "ğŸ“„ VerificaÃ§Ã£o de licenÃ§as concluÃ­da"

      - name: ğŸ” Secret Scanning (Basic)
        run: |
          echo "ğŸ” VerificaÃ§Ã£o bÃ¡sica de segredos..."

          # Verificar padrÃµes de segredos bÃ¡sicos
          echo "Verificando possÃ­veis API keys..."
          grep -r "api[_-]key" . --exclude-dir=node_modules --exclude-dir=.git || true

          echo "Verificando possÃ­veis tokens..."
          grep -r "token" . --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git | head -10 || true

          echo "Verificando possÃ­veis passwords..."
          grep -r "password.*=" . --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git | head -5 || true

          echo "âœ… VerificaÃ§Ã£o bÃ¡sica de segredos concluÃ­da"

      - name: ğŸ“Š Generate Security Report
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de seguranÃ§a..."
          node -e "
            const fs = require('fs');

            const report = {
              timestamp: new Date().toISOString(),
              audit: {
                backend: {},
                frontend: {}
              },
              licenses: {
                backend: '',
                frontend: ''
              }
            };

            try {
              if (fs.existsSync('security-audit-backend.json')) {
                const backendAudit = JSON.parse(fs.readFileSync('security-audit-backend.json', 'utf8'));
                report.audit.backend = {
                  vulnerabilities: backendAudit.metadata?.vulnerabilities || {},
                  summary: 'Auditoria executada'
                };
              }

              if (fs.existsSync('frontend-react/security-audit-frontend.json')) {
                const frontendAudit = JSON.parse(fs.readFileSync('frontend-react/security-audit-frontend.json', 'utf8'));
                report.audit.frontend = {
                  vulnerabilities: frontendAudit.metadata?.vulnerabilities || {},
                  summary: 'Auditoria executada'
                };
              }

              if (fs.existsSync('license-summary.txt')) {
                report.licenses.backend = fs.readFileSync('license-summary.txt', 'utf8');
              }

              if (fs.existsSync('frontend-react/license-summary-frontend.txt')) {
                report.licenses.frontend = fs.readFileSync('frontend-react/license-summary-frontend.txt', 'utf8');
              }

              fs.writeFileSync('security-report.json', JSON.stringify(report, null, 2));
              console.log('âœ… RelatÃ³rio de seguranÃ§a gerado');
            } catch (error) {
              console.error('âŒ Erro ao gerar relatÃ³rio:', error);
            }
          "

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ github.run_number }}
          path: security-report.json
          retention-days: 14

  # ==================== HEALTH CHECK ====================
  health-check:
    name: ğŸ¥ Application Health Check
    runs-on: ubuntu-latest
    if: github.event.schedule || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend-react && npm ci

      - name: ğŸ”§ Setup Health Check Environment
        run: |
          cd backend
          echo "NODE_ENV=test" >> .env
          echo "PORT=3005" >> .env
          echo "DB_PATH=./health-check.db" >> .env

      - name: ğŸ—„ï¸ Initialize Database
        run: |
          cd backend
          node setup-db.js

      - name: ğŸš€ Start Application for Health Check
        run: |
          cd backend
          timeout 30s npm start &
          sleep 15

      - name: ğŸ¥ Execute Health Checks
        run: |
          echo "ğŸ¥ Executando verificaÃ§Ãµes de saÃºde..."

          # Verificar se o servidor responde
          echo "ğŸ” Verificando resposta do servidor..."
          curl -f http://localhost:3005/ping || echo "âš ï¸ Servidor nÃ£o respondeu"

          # Verificar endpoints principais
          echo "ğŸ” Verificando endpoints principais..."
          curl -f http://localhost:3005/api/csrf-token || echo "âš ï¸ CSRF endpoint com problema"

          echo "âœ… VerificaÃ§Ãµes de saÃºde concluÃ­das"

      - name: ğŸ“Š Generate Health Report
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de saÃºde..."
          node -e "
            const os = require('os');
            const fs = require('fs');

            const healthReport = {
              timestamp: new Date().toISOString(),
              status: 'checked',
              system: {
                platform: os.platform(),
                nodeVersion: process.version,
                memory: {
                  used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024) + 'MB',
                  total: Math.round(os.totalmem() / 1024 / 1024) + 'MB'
                }
              },
              application: {
                healthCheckCompleted: true,
                endpoints: {
                  ping: 'tested',
                  csrf: 'tested'
                }
              }
            };

            fs.writeFileSync('health-report.json', JSON.stringify(healthReport, null, 2));
            console.log('âœ… RelatÃ³rio de saÃºde gerado');
          "

      - name: ğŸ“¤ Upload Health Report
        uses: actions/upload-artifact@v3
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.json
          retention-days: 7

  # ==================== NOTIFICAÃ‡Ã•ES DE MONITORAMENTO ====================
  notify-monitoring:
    name: ğŸ“¢ Monitoring Notifications
    runs-on: ubuntu-latest
    needs: [performance-monitoring, lighthouse-audit, security-monitoring, health-check]
    if: always()

    steps:
      - name: ğŸ“¢ Monitoring Status Summary
        run: |
          echo "ğŸ“¢ RESUMO DO MONITORAMENTO"
          echo "=========================="

          if [ "${{ needs.performance-monitoring.result }}" = "success" ]; then
            echo "âš¡ Monitoramento de Performance: âœ… SUCESSO"
          elif [ "${{ needs.performance-monitoring.result }}" = "skipped" ]; then
            echo "âš¡ Monitoramento de Performance: â­ï¸ IGNORADO"
          else
            echo "âš¡ Monitoramento de Performance: âŒ FALHA"
          fi

          if [ "${{ needs.lighthouse-audit.result }}" = "success" ]; then
            echo "ğŸ”¦ Lighthouse Audit: âœ… SUCESSO"
          elif [ "${{ needs.lighthouse-audit.result }}" = "skipped" ]; then
            echo "ğŸ”¦ Lighthouse Audit: â­ï¸ IGNORADO"
          else
            echo "ğŸ”¦ Lighthouse Audit: âŒ FALHA"
          fi

          if [ "${{ needs.security-monitoring.result }}" = "success" ]; then
            echo "ğŸ”’ Monitoramento de SeguranÃ§a: âœ… SUCESSO"
          elif [ "${{ needs.security-monitoring.result }}" = "skipped" ]; then
            echo "ğŸ”’ Monitoramento de SeguranÃ§a: â­ï¸ IGNORADO"
          else
            echo "ğŸ”’ Monitoramento de SeguranÃ§a: âŒ FALHA"
          fi

          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "ğŸ¥ Health Check: âœ… SUCESSO"
          elif [ "${{ needs.health-check.result }}" = "skipped" ]; then
            echo "ğŸ¥ Health Check: â­ï¸ IGNORADO"
          else
            echo "ğŸ¥ Health Check: âŒ FALHA"
          fi

          echo "=========================="
          echo "ğŸ•’ Timestamp: $(date -u)"
          echo "ğŸ“Š RelatÃ³rios disponÃ­veis nos artifacts"

      - name: ğŸš¨ Alert on Critical Issues
        if: contains(needs.*.result, 'failure')
        run: |
          echo "ğŸš¨ ALERTA: Problemas crÃ­ticos detectados no monitoramento!"
          echo "ğŸ“§ Enviando notificaÃ§Ãµes de alerta..."
          # Aqui vocÃª pode adicionar integraÃ§Ã£o com sistemas de alerta
          echo "ğŸ”” NotificaÃ§Ãµes de alerta enviadas"
